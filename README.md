# MindMaker v2

ALS 환자 및 의사소통이 불편한 환자가 **눈동자 움직임**과 **눈 깜빡임**만으로 의사소통할 수 있는 시선 추적 기반 보조 프로그램입니다.

웹캠으로 홍채 위치를 실시간 감지하고, 화면의 의사소통 보드에서 원하는 항목을 눈을 감아 선택하면 한국어 음성으로 출력합니다.

## 주요 기능

- **시선 추적**: MediaPipe Face Landmarker로 홍채 위치 실시간 감지 (478개 얼굴 랜드마크)
- **4x4 캘리브레이션**: 16포인트 그리드로 눈 움직임 → 화면 좌표 매핑 (릿지 회귀)
- **의사소통 보드**: 4개 카테고리 (인사 및 안부, 의사소통, 가족, 긴급) → 하위 항목 선택
- **눈 감기 선택**: 1.2초 이상 눈을 감으면 현재 시선 위치의 버튼 선택
- **TTS 음성 출력**: 버튼 선택 시 한국어 음성 출력 (Web Speech API)
- **오디오 피드백**: 호버 진입 시 틱 사운드, 선택 시 확인음
- **시선 시각화**: 화면 위 빨간 점이 시선을 따라다님
- **히스테리시스**: 시선 떨림으로 인한 버튼 반복 전환 방지
- **카메라 줌**: +/- 키로 카메라 줌 조절 (1.0x ~ 3.0x)

## 기술 스택

| 역할 | 기술 |
|------|------|
| 데스크톱 앱 | Electron 33 |
| UI | React 18 + TypeScript 5 |
| 시선 추적 | MediaPipe Face Landmarker (WASM) |
| 회귀 모델 | 2차 다항식 릿지 회귀 (자체 구현) |
| TTS | Web Speech API |
| 오디오 피드백 | Web Audio API |
| 빌드 | Vite 6 + vite-plugin-electron |

---

## 시스템 요구사항

| 항목 | 요구사항 |
|------|----------|
| OS | macOS 12+ / Windows 10+ |
| Node.js | 18 이상 |
| 웹캠 | 내장 또는 USB 웹캠 (필수) |
| 디스플레이 | 권장 1920x1080 이상 |

---

## macOS 설치 및 실행

### 1. Node.js 설치

[Node.js 공식 사이트](https://nodejs.org)에서 LTS 버전을 다운로드하거나, Homebrew로 설치합니다.

```bash
# Homebrew로 설치하는 경우
brew install node
```

설치 확인:

```bash
node -v   # v18 이상 확인
npm -v
```

### 2. 프로젝트 설치

```bash
# 프로젝트 폴더로 이동
cd mindmaker-v2

# 의존성 설치
npm install
```

### 3. 카메라 권한 허용

macOS는 앱이 카메라에 접근할 때 권한을 요청합니다.

- 처음 실행 시 **"카메라 접근을 허용하시겠습니까?"** 팝업이 나타나면 **허용**을 선택합니다.
- 만약 실수로 거부한 경우:
  - **시스템 설정 → 개인정보 보호 및 보안 → 카메라** 에서 Electron 앱을 허용으로 변경합니다.

### 4. 실행

```bash
npm run dev
```

프로그램이 전체 화면으로 실행됩니다.

### 5. 빌드 (배포용)

```bash
npm run build
```

빌드 결과물은 `dist/` 및 `dist-electron/` 폴더에 생성됩니다.

---

## Windows 설치 및 실행

### 1. Node.js 설치

[Node.js 공식 사이트](https://nodejs.org)에서 **Windows Installer (.msi)** LTS 버전을 다운로드하여 설치합니다.

설치 시 **"Add to PATH"** 옵션이 체크되어 있는지 확인합니다.

설치 확인 (명령 프롬프트 또는 PowerShell):

```powershell
node -v   # v18 이상 확인
npm -v
```

### 2. 프로젝트 설치

명령 프롬프트 또는 PowerShell을 열고:

```powershell
# 프로젝트 폴더로 이동
cd mindmaker-v2

# 의존성 설치
npm install
```

> **참고**: Windows에서 `npm install` 중 네이티브 모듈 빌드 에러가 발생하면, [Visual Studio Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/)를 설치한 후 다시 시도합니다.

### 3. 카메라 권한 허용

Windows에서는 카메라 접근 권한 설정이 필요할 수 있습니다.

- **설정 → 개인 정보 → 카메라** 에서 **"앱에서 카메라에 액세스하도록 허용"** 이 켜져 있는지 확인합니다.
- **"데스크톱 앱에서 카메라에 액세스하도록 허용"** 항목도 켜져 있어야 합니다.

### 4. 실행

```powershell
npm run dev
```

프로그램이 전체 화면으로 실행됩니다.

### 5. 빌드 (배포용)

```powershell
npm run build
```

---

## 사용 방법

### 1단계: 캘리브레이션

프로그램이 시작되면 화면에 빨간 점이 표시됩니다.

1. 환자가 빨간 점을 **바라봅니다**
2. 보호자가 **Space 키**를 누릅니다
3. 30프레임 수집 후 다음 점으로 자동 이동
4. 16개 포인트 완료 시 의사소통 보드로 전환

> 캘리브레이션 중 이상치는 자동으로 제거됩니다. 정확도가 낮으면 **R 키**로 재캘리브레이션할 수 있습니다.

### 2단계: 카테고리 선택

의사소통 보드는 2x2 그리드의 카테고리 화면으로 시작합니다.

```
+----------------+----------------+
|  인사 및 안부  |    의사소통    |
+----------------+----------------+
|      가족      |      긴급      |
+----------------+----------------+
```

원하는 카테고리를 바라보고 **눈을 1.2초 이상 감으면** 해당 카테고리로 이동합니다.

### 3단계: 항목 선택

카테고리 진입 후 하위 항목 목록이 표시됩니다. (예: 긴급)

```
+----------+----------------+------------------+------------------+
|  ← 뒤로  |      아파      |  간호사 불러줘   | 화장실 가고 싶어 |
+----------+----------------+------------------+------------------+
|          | 약 먹을 시간이야|   숨이 답답해    |     도와줘       |
+----------+----------------+------------------+------------------+
```

- 항목을 바라보고 **눈을 1.2초 이상 감으면** 선택 → **음성으로 출력**됩니다.
- **← 뒤로** 를 선택하면 카테고리 화면으로 돌아갑니다.

### 시각/청각 피드백

- 시선이 버튼 위에 오면 **파란 글로우 테두리**로 하이라이트 + **틱 소리**
- 화면 하단에 **현재 시선 대상 텍스트**가 크게 표시됩니다
- 눈 감기 진행 상황이 **프로그레스 바**로 표시됩니다
- 선택 완료 시 **확인음** 재생 후 **TTS 음성** 출력

---

## 조작 키 (보호자용)

| 키 | 기능 |
|----|------|
| **Space** | 캘리브레이션 포인트 수집 |
| **R** | 재캘리브레이션 |
| **Ctrl+D** | 디버그 패널 토글 |
| **+** / **-** | 카메라 줌 조절 |
| **Q** | 프로그램 종료 |

---

## 프로젝트 구조

```
mindmaker-v2/
├── electron/
│   ├── main.ts                  # Electron 메인 프로세스 (전체 화면 윈도우)
│   └── preload.ts               # Preload 스크립트
├── src/
│   ├── App.tsx                  # 앱 상태 관리 (로딩 → 캘리브레이션 → 보드)
│   ├── config.ts                # 모든 튜닝 파라미터 중앙 관리
│   ├── main.tsx                 # React 엔트리포인트
│   ├── tracking/
│   │   ├── EyeTracker.ts        # MediaPipe 래퍼 + 랜드마크 추출
│   │   ├── BlinkDetector.ts     # EAR 계산 + 눈 감기 감지
│   │   ├── GazeMapper.ts        # 특징 추출 + 릿지 회귀 + 스무딩
│   │   └── useTracker.ts        # React 훅 (카메라 + 트래킹 통합)
│   ├── components/
│   │   ├── CalibrationScreen.tsx # 4x4 캘리브레이션 화면
│   │   ├── CommBoard.tsx         # 의사소통 보드 (카테고리 계층)
│   │   ├── GazeOverlay.tsx       # 시선 빨간 점 오버레이
│   │   └── DebugPanel.tsx        # 디버그 정보 패널
│   └── styles/
│       └── index.css             # 전체 스타일
├── index.html                    # HTML 엔트리포인트
├── vite.config.ts                # Vite + Electron 빌드 설정
├── tsconfig.json                 # TypeScript 설정
└── package.json                  # 의존성 및 스크립트
```

---

## 설정 파라미터

주요 파라미터는 `src/config.ts`에서 조정할 수 있습니다.

| 파라미터 | 기본값 | 설명 |
|---------|--------|------|
| `EYE_CLOSE_SELECT_SEC` | 1.2 | 눈 감기 선택 시간 (초) |
| `HIT_TEST_PADDING_PX` | 40 | 버튼 히트 영역 확장 (px) |
| `HYSTERESIS_EXTRA_PX` | 30 | 호버 이탈 히스테리시스 (px) |
| `SMOOTHING_ALPHA` | 0.10 | 시선 스무딩 강도 (낮을수록 부드러움) |
| `MOVING_AVG_SIZE` | 8 | 이동 평균 버퍼 크기 |
| `MIN_MOVE_PX` | 15 | 미세 떨림 무시 범위 (px) |
| `GAZE_SENSITIVITY` | 0.9 | 시선 매핑 민감도 |
| `GAZE_FREEZE_EAR` | 0.24 | 눈 감김 판단 EAR 임계값 |

---

## 문제 해결

### 카메라가 감지되지 않는 경우

- 웹캠이 물리적으로 연결되어 있는지 확인합니다.
- 다른 프로그램이 카메라를 사용 중이면 종료합니다.
- macOS: 시스템 설정 → 개인정보 보호 및 보안 → 카메라 권한을 확인합니다.
- Windows: 설정 → 개인 정보 → 카메라에서 데스크톱 앱 접근이 허용되어 있는지 확인합니다.

### 시선 추적이 부정확한 경우

- **R 키**로 재캘리브레이션을 시도합니다.
- 환자의 얼굴이 카메라 정면을 향하고 있는지 확인합니다.
- 조명이 균일하고 충분한지 확인합니다 (역광 주의).
- **+/-** 키로 카메라 줌을 조절하여 얼굴이 화면에 적절한 크기로 나오도록 합니다.

### `npm install` 에러 (Windows)

- [Visual Studio Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/)를 설치합니다.
- PowerShell을 관리자 권한으로 실행하여 다시 시도합니다.

---